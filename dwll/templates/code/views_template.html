"""

Module {{app.name}} Views Documentation

"""
{% load bgen %}from django.http import HttpResponseRedirect, Http404
from django.views.generic import UpdateView, CreateView, ListView, DeleteView
from django.urls import reverse
from braces.views import UserPassesTestMixin
from dwll import messages
from django.contrib import messages as django_messages

from . import models, forms


class SignupView(CreateView):
    """

    Registration View

    """
    template_name = 'profile/signup.html'
    form_class = forms.SignupForm

    def get_context_data(self, **kwargs):
        ctx = super().get_context_data(**kwargs)
        return ctx

    def form_valid(self, form, **kwargs):
        """

        Form Valid

        Description
            This method is called when valid form data has been POSTed.
            It should return an HttpResponse.

        :param form:
        :return: HttpResponse
        """

        # Recupera los parametros del formulario
        company = form.save()
        if company:
            emails.EmailSender().send_request_approve_company(company)
            django_messages.success(self.request, messages.get_full_message(
                self.request, 'companies.create.success'))

        return HttpResponseRedirect(self.get_success_url())

    def form_invalid(self, form, **kwargs):
        """

        Form Invalid

        :param form:
        :param kwargs:
        :return:
        """
        context = self.get_context_data(**kwargs)
        return self.render_to_response(context)

    def get_form_kwargs(self):
        """

        Get Form Kwargs

        Description
            Sobrescribimos este metodo para pasar el parametro request al
            formulario CompanyCreateView

        :return:
        """
        kwargs = super(ProductorCompanyCreateView, self).get_form_kwargs()
        kwargs.update({'request': self.request})
        return kwargs

    def get_success_url(self):
        """

        Get Success URL

        Description
            Configura la URL de exito en base a los parametros recuperados en
            el formulario de esta vista.

        """
        return reverse('dashboard')

    def get_fail_url(self):
        """

        Get Fail URL

        Description
            Configura la URL de fallo en base a los parametros recuperados en
            el formulario de esta vista.

        """
        return reverse('create_prod_company')


class ProfileUpdateView(UserPassesTestMixin, UpdateView):
    """

    Profile Update View

    :desciption Vista de actualizacion de registros de tipo {{ model.name }}

    """
    template_name = '{{app.name}}/update_{{ model.name|lower }}.html'
    model = models.{{model.name}}
    form_class = forms.{{model.name}}CreateUpdateForm

    def test_func(self, user):
        """Revision de permisos de acceso a esta vista"""
        if not user.is_authenticated:
            self.login_url = reverse('account_login')
            return False

        # Aqui otras condiciones
        return True

    def form_valid(self, form, **kwargs):
        """
        Form Valid
        :desciption This method is called when valid form data has been POSTed. It should return an HttpResponse.
        :param form:
        :return: HttpResponse
        """
        obj = form.save()
        if obj:
            django_messages.success(self.request, messages.get_full_message(self.request, '{{ model.name|lower }}.update.success'))

        return HttpResponseRedirect(self.get_success_url())

    def form_invalid(self, form, **kwargs):
        """
        Form Invalid
        :param form:
        :param kwargs:
        :return:
        """
        context = self.get_context_data(**kwargs)
        # Do whatever here with form error
        return self.render_to_response(context)

    def get_form_kwargs(self):
        """
        Get Form Kwargs
        :desciption Sobrescribimos para pasar el parametro request al formulario {{ model.name }}CreateUpdateForm
        :return:
        """
        kwargs = super({{ model.name }}UpdateView, self).get_form_kwargs()
        kwargs.update({'request': self.request})
        return kwargs

    def get_success_url(self):
        """
        Get Success URL
        :desciption Configura la URL de exito al procesar esta vista
        """
        return reverse('home')

    def get_fail_url(self):
        """
        Get Fail URL
        :desciption Configura la URL de fallo en base a los parametros recuperados en el formulario de esta vista.
        """
        return reverse('update_{{ model.name|lower }}'){% endfor %}

